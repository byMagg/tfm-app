---
import Layout from '@/layouts/Layout.astro'
import { DataTable } from '@/components/DataTable'
import type { ColumnDef } from '@tanstack/react-table'
import type { TrafficCrash } from '@/types'

const columns: ColumnDef<TrafficCrash>[] = [
  {
    accessorKey: 'CRASH_RECORD_ID',
    header: 'ID',
  },
  {
    accessorKey: 'POSTED_SPEED_LIMIT',
    header: 'Speed Limit',
  },
  {
    accessorKey: 'LOCATION',
    header: 'Location',
  },
  {
    accessorKey: 'CRASH_DATE',
    header: 'Date',
  },
  {
    accessorKey: 'WEATHER_CONDITION',
    header: 'Weather',
  },
]

async function getData(): Promise<TrafficCrash[]> {
  try {
    const response = await fetch('http://localhost:3000', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        query: `
          query GetCrashes {
              getCrashes(limit: 10) {
                  CRASH_RECORD_ID
                  CRASH_DATE
                  WEATHER_CONDITION
                  LOCATION
                  POSTED_SPEED_LIMIT
              }
          }
        `,
      }),
    })

    if (!response.ok) throw new Error('No se ha podido obtener los datos')

    const { data } = await response.json()
    return data.getCrashes
  } catch (error) {
    if (error instanceof Error) {
      if (error.cause.code === 'ECONNREFUSED') {
        console.error('No se ha podido conectar con el servidor')
      }
    }
  }
  return []
}

const data = await getData()
---

<Layout title="Astro">
  <div class="container mx-auto py-10">
    <DataTable client:visible columns={columns} data={data} />
  </div>
</Layout>
@/constants/constants
